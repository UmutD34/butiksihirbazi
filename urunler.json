# -*- coding: utf-8 -*-
import json
import os
import re

print("\n" + "="*60)
print("ğŸ§  MUTEDRA: VERÄ° ONARIM VE ENTELEKTÃœEL DÃ–NÃœÅÃœM MOTORU")
print("="*60 + "\n")

# --- 1. ZÄ°HÄ°N KÃœTÃœPHANESÄ° (GELÄ°ÅMÄ°Å SENARYOLAR) ---
INTELLIGENCE_MAP = {
    # LÄ°DERLÄ°K & GÃœÃ‡
    "AtatÃ¼rk": {
        "tags": ["Lider", "Vizyon", "Cumhuriyet", "GÃ¼Ã§", "Baba", "Ofis", "CEO"],
        "allegory": "Bir ulusun kÃ¼llerinden doÄŸuÅŸunun somutlaÅŸmÄ±ÅŸ iradesi.",
        "sales_tips": ["Makam odalarÄ± iÃ§in prestij ve aÄŸÄ±rlÄ±k simgesi.", "Vizyonerlik mesajÄ± vermek isteyen yÃ¶neticilere."],
        "story": "Sadece bir obje deÄŸil, bir duruÅŸ. Cumhuriyetin kurucu iradesinin ve modernleÅŸme vizyonunun zamansÄ±z bir hatÄ±rasÄ±."
    },
    "Ä°stiklal": {
        "tags": ["BaÄŸÄ±msÄ±zlÄ±k", "Otorite", "Ä°mza", "Devlet", "Hukuk"],
        "allegory": "Ä°radenin kalÄ±cÄ± izi, sÃ¶zÃ¼n senete dÃ¶nÃ¼ÅŸmesi.",
        "sales_tips": ["Ä°mza yetkisi olan yÃ¶netici ve avukatlara gÃ¼Ã§ sembolÃ¼.", "Yeni baÅŸlangÄ±Ã§lar ve terfi kutlamalarÄ± iÃ§in."],
        "story": "BaÄŸÄ±msÄ±zlÄ±ÄŸÄ±n imzasÄ±. Cumhuriyetin kuruluÅŸ iradesini masanÄ±zda yaÅŸatan, kararlÄ±lÄ±ÄŸÄ± simgeleyen Ã¶zel tasarÄ±m."
    },
    "Fatih": {
        "tags": ["Fetih", "GÃ¼Ã§", "Lider", "Strateji", "Ä°stanbul"],
        "allegory": "Ã‡aÄŸ aÃ§Ä±p Ã§aÄŸ kapatan iradenin yansÄ±masÄ±.",
        "sales_tips": ["BÃ¼yÃ¼k hedefleri olan giriÅŸimcilere.", "Tarih ve strateji tutkunlarÄ±na."],
        "story": "Ä°mkansÄ±zÄ± mÃ¼mkÃ¼n kÄ±lan Fatih'in vizyonu. Ä°stanbul'un fethinin ve OsmanlÄ±'nÄ±n yÃ¼kseliÅŸinin sembolÃ¼."
    },

    # AÅK & ROMANTÄ°ZM
    "GÃ¼l": {
        "tags": ["AÅŸk", "Romantik", "KadÄ±n", "Anne", "Zarafet", "Sevgi"],
        "allegory": "Sevginin ve zarafetin aÃ§an goncasÄ±.",
        "sales_tips": ["Romantik ruhlu kadÄ±nlara ve annelere.", "SÄ±radan bir hediye deÄŸil, bir aÅŸk ilanÄ±."],
        "story": "Saray bahÃ§elerindeki gÃ¼llerin sofraya iniÅŸi. AltÄ±n ve pembe detaylarla bezeli, romantik ve asil bir dokunuÅŸ."
    },
    "KÄ±smet": {
        "tags": ["DÃ¼ÄŸÃ¼n", "Ã‡eyiz", "AÅŸk", "SÄ±r", "Hazine", "Gelin"],
        "allegory": "Gizli hazinelerin ve umutlarÄ±n muhafÄ±zÄ±.",
        "sales_tips": ["DÃ¼ÄŸÃ¼n, niÅŸan ve sÃ¶z iÃ§in 'uÄŸurlu baÅŸlangÄ±Ã§' hediyesi.", "Ä°Ã§ine konulanÄ± deÄŸerli kÄ±lan, saklama duygusuna hitap eden obje."],
        "story": "OsmanlÄ±'nÄ±n Ã§eyiz sandÄ±ÄŸÄ± geleneÄŸi. Sedef kakma iÅŸÃ§iliÄŸinin cam Ã¼zerindeki zarif yansÄ±masÄ±. SÄ±rlarÄ± saklayan kutu."
    },
    "Seyran": {
        "tags": ["AÅŸk", "Åiir", "Masal", "Fantastik", "DoÄŸa"],
        "allegory": "Cennet bahÃ§esinde bir gezinti.",
        "sales_tips": ["Hayalperestlere ve sanatseverlere.", "Sofrada ÅŸiirsel bir atmosfer yaratÄ±r."],
        "story": "Safavi dÃ¶nemi HafÄ±z DivanÄ±'nÄ±n cildindeki cennet bahÃ§esi. Simurglar, ejderhalar ve orman minyatÃ¼rleriyle bezeli, ÅŸiirsel bir eser."
    },

    # DENÄ°ZCÄ°LÄ°K & ROTA
    "Karadeniz": {
        "tags": ["Denizci", "Gemi", "Vizyon", "Seyahat", "GiriÅŸimci"],
        "allegory": "Ufkun Ã¶tesine taÅŸÄ±nan medeniyet mesajÄ±.",
        "sales_tips": ["Denizcilik sektÃ¶rÃ¼ne ve vizyonerlere.", "DÃ¼nyaya aÃ§Ä±lma hedefini simgeler."],
        "story": "1926'da genÃ§ Cumhuriyetin Ã¼rÃ¼nlerini Avrupa'ya tanÄ±tan efsanevi 'YÃ¼zen Sergi'. Modern TÃ¼rkiye'nin vizyonunu okyanuslara taÅŸÄ±yan gemi."
    },
    "Piri Reis": {
        "tags": ["Denizci", "Harita", "Rota", "KaÅŸif", "DÃ¼nya"],
        "allegory": "Bilinmeze yapÄ±lan yolculukta pusula olmak.",
        "sales_tips": ["Yolunu arayanlara veya yeni iÅŸ kuranlara.", "Deniz ve harita tutkunlarÄ±na."],
        "story": "DÃ¼nya haritasÄ±nÄ± Ã§izen bÃ¼yÃ¼k denizci Piri Reis'in mirasÄ±. YÃ¶nÃ¼nÃ¼ bulmak isteyenlere rehber."
    },

    # MANEVÄ°YAT & HUZUR
    "Mevlana": {
        "tags": ["Huzur", "Tasavvuf", "HoÅŸgÃ¶rÃ¼", "Terapi", "SabÄ±r"],
        "allegory": "HamdÄ±m, piÅŸtim, yandÄ±m dÃ¶ngÃ¼sÃ¼.",
        "sales_tips": ["Stresli iÅŸ hayatÄ±nda sÃ¼kunet arayanlara.", "Manevi derinliÄŸi olan bir hediye."],
        "story": "Gel, ne olursan ol yine gel. Ä°nsanlÄ±ÄŸa aÅŸkÄ± ve hoÅŸgÃ¶rÃ¼yÃ¼ Ã¶ÄŸreten felsefenin camdaki aksi."
    },
    "Vav": {
        "tags": ["Teslimiyet", "BaÅŸlangÄ±Ã§", "Allah", "MÃ¼tevazÄ±", "Denge"],
        "allegory": "Anne karnÄ±ndaki cenin, secde eden insan: Acziyet.",
        "sales_tips": ["SabÄ±r dileyenlere ve yeni baÅŸlangÄ±Ã§ yapanlara.", "Evin en huzurlu kÃ¶ÅŸesi iÃ§in."],
        "story": "Ä°nsanÄ±n Yaradan karÅŸÄ±sÄ±ndaki bÃ¼kÃ¼lÃ¼ÅŸÃ¼. 'Vav' gibi mÃ¼tevazÄ±, 'Elif' gibi dimdik olabilmenin sÄ±rrÄ±."
    },
    "Asklepios": {
        "tags": ["Doktor", "SaÄŸlÄ±k", "Åifa", "TÄ±p", "EczacÄ±", "Ofis"],
        "allegory": "AcÄ±nÄ±n dindirilmesi, yaÅŸamÄ±n kutsanmasÄ±.",
        "sales_tips": ["Doktor, eczacÄ± ve saÄŸlÄ±k Ã§alÄ±ÅŸanlarÄ±na en prestijli hediye.", "Muayenehanelere 'gÃ¼ven ve ÅŸifa' enerjisi katar."],
        "story": "Bergama'nÄ±n ÅŸifa tanrÄ±sÄ± Asklepios. TÄ±bbÄ±n sembolÃ¼ yÄ±lanlÄ± asa figÃ¼rÃ¼yle saÄŸlÄ±ÄŸÄ± ve iyileÅŸmeyi yÃ¼celten tarihi bir dokunuÅŸ."
    },

    # SANAT & FÃœREYA
    "FÃ¼reya": {
        "tags": ["KadÄ±n", "Sanat", "Devrim", "Seramik", "Ã–zgÃ¼rlÃ¼k"],
        "allegory": "SanatÄ±n mÃ¼zeden Ã§Ä±kÄ±p hayata karÄ±ÅŸmasÄ±.",
        "sales_tips": ["GÃ¼Ã§lÃ¼ kadÄ±nlara ve sanat tarihi tutkunlarÄ±na.", "SÄ±radÄ±ÅŸÄ± ve hikayesi olan bir parÃ§a."],
        "story": "Ä°lk Ã§aÄŸdaÅŸ seramikÃ§imiz FÃ¼reya Koral'Ä±n manifestosu. 'Sanat mÃ¼zelerde hapsolmamalÄ±, hayatÄ±n iÃ§inde yaÅŸamalÄ±' diyen o devrimci ruh."
    },
    "Omnia": {
        "tags": ["Modern", "TasarÄ±m", "Yenilik", "GenÃ§", "Stil"],
        "allegory": "Gelenekselin modern dekonstrÃ¼ksiyonu.",
        "sales_tips": ["Modern ev dekorasyonu seven genÃ§ profesyonellere.", "TasarÄ±m odaklÄ± dÃ¼ÅŸÃ¼nenlere."],
        "story": "HayatÄ±n her hali (Omnia). ÃœnlÃ¼ tasarÄ±mcÄ±larÄ±n PaÅŸabahÃ§e mirasÄ±nÄ± modern formlarla yeniden yorumladÄ±ÄŸÄ± zamansÄ±z koleksiyon."
    }
}

# --- 2. DOSYA OKUMA VE ONARMA (CERRAHÄ° MÃœDAHALE) ---
def load_and_fix_json(filepath):
    if not os.path.exists(filepath):
        print("âŒ HATA: 'urunler.json' bulunamadÄ±.")
        return []

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read().strip()

    # Hata 1: Sonda fazladan } veya ] varsa temizle
    while content.endswith('}') or content.endswith(']'):
        # EÄŸer valid bir son deÄŸilse (iÃ§ iÃ§e yapÄ± hatasÄ±)
        # BasitÃ§e en son geÃ§erli ] karakterini bulup oradan keselim
        if content.count('[') == content.count(']'):
            break # Parantez sayÄ±larÄ± eÅŸitse muhtemelen doÄŸrudur
        content = content[:-1].strip()
    
    # Hata 2: Listenin sonunda virgÃ¼l kalmÄ±ÅŸsa (..., ] -> ... ])
    content = re.sub(r',(\s*])', r'\1', content)

    # Hata 3: EÄŸer dosya bir listeyle bitmiyorsa zorla kapat
    if not content.endswith(']'):
        content += ']'

    try:
        data = json.loads(content)
        print(f"âœ… JSON baÅŸarÄ±yla onarÄ±ldÄ± ve okundu. ({len(data)} Ã¼rÃ¼n)")
        return data
    except json.JSONDecodeError as e:
        print(f"âš ï¸ Otomatik onarÄ±m yetmedi, satÄ±r satÄ±r kurtarma deneniyor... Hata: {e}")
        # Acil Durum: DosyayÄ± satÄ±r satÄ±r okuyup valid objeleri Ã§ekmeye Ã§alÄ±ÅŸ
        recovered_data = []
        # Basit regex ile objeleri yakala
        objects = re.findall(r'\{.*?"name":.*?\}(?=,|$)', content, re.DOTALL)
        for obj_str in objects:
            try:
                obj = json.loads(obj_str)
                recovered_data.append(obj)
            except:
                pass
        
        if recovered_data:
            print(f"âœ… Kurtarma baÅŸarÄ±lÄ±! {len(recovered_data)} Ã¼rÃ¼n kurtarÄ±ldÄ±.")
            return recovered_data
        else:
            print("âŒ Kritik Hata: Veri kurtarÄ±lamadÄ±. Dosya formatÄ± Ã§ok bozuk.")
            return []

# --- 3. AKILLI Ä°ÅLEME VE ZENGÄ°NLEÅTÄ°RME ---
def enrich_product(product):
    name = product.get('name', '')
    raw_story = product.get('raw_story', '')
    
    # Temel Temizlik
    enriched = product.copy()
    
    # VarsayÄ±lan DeÄŸerler
    enriched['short_story'] = f"{name}, PaÅŸabahÃ§e'nin ustalÄ±ÄŸÄ±yla ÅŸekillenmiÅŸ, zamansÄ±z bir parÃ§adÄ±r."
    enriched['tags'] = ["Dekorasyon", "Cam", "Hediye"]
    enriched['sales_tips'] = ["Zarafet arayanlar iÃ§in ideal.", "Kaliteli el iÅŸÃ§iliÄŸi vurgusu yapÄ±n."]
    enriched['allegory'] = "Maddenin estetikle buluÅŸmasÄ±."

    # Zeka HaritasÄ± TaramasÄ±
    matched = False
    for key, info in INTELLIGENCE_MAP.items():
        # Ä°simde veya ham hikayede anahtar kelime var mÄ±?
        if key.lower() in name.lower() or key.lower() in raw_story.lower():
            enriched['short_story'] = info['story']
            enriched['tags'] = info['tags']
            enriched['sales_tips'] = info['sales_tips']
            enriched['allegory'] = info['allegory']
            matched = True
            break
            
    # EÄŸer Ã¶zel eÅŸleÅŸme yoksa genel kategorilere bak
    if not matched:
        if "Vazo" in name:
            enriched['tags'].append("Vazo")
            enriched['sales_tips'] = ["Ã‡iÃ§eklerle veya tek baÅŸÄ±na heykelsi bir duruÅŸ.", "Salonun odak noktasÄ±."]
        elif "Kase" in name or "Gondol" in name:
            enriched['tags'].append("Sunum")
            enriched['sales_tips'] = ["Masa ortasÄ± (Centerpiece) olarak zengin duruÅŸ.", "Ä°kram ve dekorasyon iÃ§in."]
        elif "Fincan" in name or "Bardak" in name:
            enriched['tags'].extend(["Ä°kram", "Sohbet", "Kahve"])
            enriched['sales_tips'] = ["KÄ±rk yÄ±l hatÄ±rÄ± olan sohbetler iÃ§in.", "Sunuma Ã¶nem verenlere."]

    # Fiyat TemizliÄŸi
    price = enriched.get('price', '')
    if not price or price == "Fiyat Sitede":
        enriched['price'] = "MaÄŸazada GÃ¶rÃ¼nÃ¼z"

    return enriched

# --- 4. ANA Ä°ÅLEM ---
def main():
    json_path = 'urunler.json'
    
    # 1. YÃ¼kle ve Onar
    raw_data = load_and_fix_json(json_path)
    
    if not raw_data:
        return

    # 2. Ä°ÅŸle
    print("âš™ï¸ Veriler iÅŸleniyor ve akÄ±llandÄ±rÄ±lÄ±yor...")
    final_data = [enrich_product(p) for p in raw_data]

    # 3. Kaydet
    try:
        with open(json_path, 'w', encoding='utf-8') as f:
            json.dump(final_data, f, ensure_ascii=False, indent=2)
        
        print("\n" + "="*60)
        print(f"ğŸ‰ Ä°ÅLEM TAMAMLANDI!")
        print(f"ğŸ“ {len(final_data)} Ã¼rÃ¼n baÅŸarÄ±yla kaydedildi.")
        print("ğŸ’¡ VeritabanÄ± artÄ±k 'AÅŸk', 'GÃ¼Ã§', 'Doktor' gibi sorgularÄ± anlÄ±yor.")
        print("ğŸ‘‰ UygulamayÄ± baÅŸlatmak iÃ§in: streamlit run app.py")
        print("="*60 + "\n")
        
    except Exception as e:
        print(f"âŒ Kaydetme hatasÄ±: {e}")

if __name__ == "__main__":
    main()
